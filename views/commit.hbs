{{> repo_header}}

<nav class="UnderlineNav">
  <div class="content">
    <div class="UnderlineNav-body">
      <a href="/deploy/{{owner}}/{{repo}}" role="tab" title="Deploy" class="UnderlineNav-item">Deploy</a>
    </div>
  </div>
</nav>
</header>

<div class="bg-white fill">
  <div class="content">
    <details class="details-reset details-overlay pt-3" style="display: inline-block;">
      <summary class="btn btn-sm" type="button" aria-haspopup="true" aria-expanded="true">
        Target: <b>{{target}}</b>
      </summary>
      <div class="SelectMenu">
        <div class="SelectMenu-modal">
          <menu class="SelectMenu-list">
            {{#each targets}}
            <a href="/deploy/{{name}}/{{../owner}}/{{../repo}}/{{../branch}}/{{../sha}}" class="SelectMenu-item" role="menuitem">
              {{name}}
            </a>
            {{/each}}
          </menu>
        </div>
      </div>
    </details>

    <div class="Box mt-3">
      <div class="Box-footer pb-5 bg-gray-light">
        <div id="syncing"
          class="tooltipped tooltipped-n float-right"
          aria-label="Watching deployment statuses. Deployments below will update on change.">
          {{> icon_clock}}
        </div>
        <h4>
          <a class="text-gray-dark" target="_blank" href="https://github.com/{{owner}}/{{repo}}/commit/{{oid}}">
            {{message}}
          </a>
        </h4>
        <div class="text-gray-light">
          <strong><code>{{oidShort}}</code></strong> - <a href="https://github.com/{{author}}">@{{author}}</a>
        </div>
      </div>
      {{#if error}}
      <h2>Deployment failed</h2>
      <p id="error" class="text-red">{{error}}</p>
      {{else}}
      <div id="deploy-status" style="transition: 0.5s;">
        {{> deploy_status_body}}
      </div>

      <div class="Box-footer">
        {{> deploy_button}}
      </div>
      {{/if}}
    </div>
  </div>
</div>

<script>
  (function () {
    var previous = "{{hash}}";
    function refresh() {
      fetch(window.location.href, {
          method: "GET",
          headers: { accept: "application/json" },
        })
        .then(function (resp) { return resp.json() })
        .then(function (data) {
          // Don't update the UI if we've already seen this data before.
          if (data.hash === previous) {
            return;
          }
          previous = data.hash;
          var el = document.getElementById("deploy-status");
          el.innerHTML = Handlebars.partials.deploy_status_body(data);
        }).catch(function (err) {
          console.error(err);
        });
    }

    document.addEventListener("repo-update", function() {
      refresh();
    });

    document.addEventListener("watch-loaded", function() {
      document.dispatchEvent(
        new CustomEvent("repo-listen", { detail: {
          owner: "{{owner}}",
          repo: "{{repo}}",
          repoId: "{{repoId}}",
        }})
      );
    });
  })();
</script>
{{> footer}}
